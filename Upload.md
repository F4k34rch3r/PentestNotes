# 任意文件上传漏洞

# 漏洞形成

Web 应用开放了文件上传功能但未做足够限制，导致攻击者可以通过上传精心构造的可被后端脚本语言解析的文件，从而获取Web中间件或系统命令执行权限。

# 环境搭建

直接从 dockerhub pull 靶机镜像：

```
docker run -itd -p80:80 8evan8/upload-labs:0.3
docker ps
```

Kali 虚拟机里面已经创建容器，直接开启即可：

```
docker start f5ba
```

# 利用方式

## 基本步骤

1. 准备要上传的文件

大部分文件上传功能是针对图片上传，例如上传用户头像、编辑器插入图片等。

首先用 mspaint 创建一个普通的图片：

![image-20230307163547338](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071635412.png)

2. 上传文件，查看是否成功及上传后的文件路径

打开 Pass-01 上传图片，同时用 burp 抓包。

![image-20230307163721847](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071637938.png)

上传完成后，图片显示在页面上。

![image-20230307163817911](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071638997.png)

查看 burp 抓包，请求包里面明显看到一个 POST，就是上传的请求包。

![image-20230307163938953](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071639035.png)

响应包里看到页面显示图片对应的图片路径（可以在图片上点右键 -> 复制图像地址 找到）：

![image-20230307164135601](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071641683.png)

3. 尝试上传 WebShell

Ctrl+r 将抓包发送到 burp repeater。在 repeater 中修改请求包中的文件扩展名为可解析的 php，并在文件内容中加入一句话木马。

![image-20230307164720757](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071647858.png)

尝试访问已上传的文件，能看到除 php 脚本外的所有内容，说明文件上传成功并能被 php 正常解析。

![image-20230307164912256](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071649300.png)

尝试传递 php 语句 phpinfo(); 进一步验证能否正常执行命令。

![image-20230307165112416](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071651500.png)

尝试使用 php 的system() 函数执行系统命令。

![image-20230307165544467](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071655530.png)

使用蚁剑连接

![image-20230307165736027](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071657095.png)

用蚁剑浏览文件

![image-20230307165813852](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071658954.png)

用蚁剑执行命令

![image-20230307165843833](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071658890.png)

## 扩展名黑名单绕过

PASS-03

```
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array('.asp','.aspx','.php','.jsp');
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //收尾去空

        if(!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;            
            if (move_uploaded_file($temp_file,$img_path)) {
                 $is_upload = true;
            } else {
                $msg = '上传出错！';
            }
        } else {
            $msg = '不允许上传.asp,.aspx,.php,.jsp后缀文件！';
        }
    } else {
        $msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
    }
}
```

查看后台源码，将扩展名 .php 设置为黑名单，不允许上传。

此时可以使用以下扩展名尝试上传，并测试是否可以被后台解析：

```
php
PhP
pht
phtml
php3
php5
```

本题上传 .pht 文件可成功。

## 上传配置文件使图片被解析

PASS-04

```
$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array(".php",".php5",".php4",".php3",".php2","php1",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2","pHp1",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx",".aSmx",".cEr",".sWf",".swf");
        $file_name = trim($_FILES['upload_file']['name']);
        $file_name = deldot($file_name);//删除文件名末尾的点
        $file_ext = strrchr($file_name, '.');
        $file_ext = strtolower($file_ext); //转换为小写
        $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DATA
        $file_ext = trim($file_ext); //收尾去空

        if (!in_array($file_ext, $deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$file_ext;
            if (move_uploaded_file($temp_file, $img_path)) {
                $is_upload = true;
            } else {
                $msg = '上传出错！';
            }
        } else {
            $msg = '此文件不允许上传!';
        }
    } else {
        $msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
    }
}
```

黑名单覆盖了所有可能被解析的扩展名，此时考虑上传配置文件使图片被解析。

.htaccess 写入以下内容，同目录下的 jpg 文件可被解析。

```
<FilesMatch ".jpg">
SetHandler application/x-httpd-php
</FilesMatch>
```

上传 .htaccess 文件。

![image-20230307171423028](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071714147.png)

上传图片，扩展名为 .jpg，内容插入一句话木马。

![image-20230307172158143](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071721245.png)

成功。

![image-20230307172244396](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303071722481.png)

SUCTF-2019 checkin

.htaccess 也在黑名单内，但上传文件后在同目录下自动生成一个空的index.php，这种情况可上传 .user.ini 使特定文件被自动包含到 index.php 中。

![image-20230308133911524](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081339608.png)

上传图片马（此处因后台对文件内容过滤了问号，使用script标签代替）

![image-20230308135327638](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081353740.png)

上传 .user.ini 文件，使 logo.png 被同目录下所有文件自动包含。

![image-20230308134938466](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081349583.png)

上传完成后，访问此 index.php，页面并没有包含 logo.png。

别急，需要等待 user_ini.cache_ttl 所设置的时长，默认为 300 秒。

![image-20230308140819684](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081408801.png)

访问 index.php 成功包含图片马，在 phpinfo 中看到 userini 加载时长为 300 秒。

## 扩展名大小写绕过

![image-20230308144445109](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081444233.png)

![image-20230308144648625](https://raw.githubusercontent.com/F4k34rch3r/pic-md/main/202303081446741.png)









